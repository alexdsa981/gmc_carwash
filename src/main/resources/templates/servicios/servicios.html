<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMC - ATENCIÓN</title>
    <link rel="icon" href="/img/logo.png" type="image/png">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>
<style>
    /* Estilo para los campos deshabilitados (opacos) */
    .disabled-input {
        background-color: #f8f9fa;
        opacity: 0.5;
    }
</style>
<style>
    .modal-body small {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 4px;
        display: block;
    }
</style>

<body>

<div class="container mt-5">
    <h2 class="text-center mb-4">GMC - SERVICIOS</h2>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/inicio" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i> Volver a Inicio
            </a>
        </div>
    </div>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ingresos-tab" data-bs-toggle="tab" data-bs-target="#ingresos"
                    type="button" role="tab" aria-controls="ingresos" aria-selected="true">INGRESOS
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="realizados-tab" data-bs-toggle="tab" data-bs-target="#realizados"
                    type="button" role="tab" aria-controls="realizados" aria-selected="false">REALIZADOS
            </button>
        </li>
    </ul>

    <div class="tab-content mt-4" id="myTabContent">
        <!-- Vista de INGRESOS -->
        <div class="tab-pane fade show active" id="ingresos" role="tabpanel" aria-labelledby="ingresos-tab">

            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addIngresoModal">AÑADIR
                INGRESO
            </button>
            <table id="example" class="table table-striped table-bordered" style="width:100%">
                <thead>
                <tr>
                    <th>Nº</th>
                    <th>VEHICULO</th>
                    <th>CLIENTE</th>
                    <th>SERVICIOS/PRODUCTOS</th>
                    <th>FECHA</th>
                    <th>ACCIONES</th>
                </tr>
                </thead>
                <tbody>
                <th:block th:each="detalle, iterStat : ${listaIngresos}">
                    <tr>
                        <td th:text="${iterStat.index + 1}">Nº</td>
                        <td>
                            <strong th:text="${detalle.vehiculo != null ? detalle.vehiculo.placa : ''}">PLACA</strong><br>
                            <span th:text="${detalle.vehiculo != null ? detalle.vehiculo.marca : ''}">MARCA</span><br>
                            <span th:text="${detalle.vehiculo != null && detalle.vehiculo.tipo_vehiculo != null ? detalle.vehiculo.tipo_vehiculo.nombre : ''}">TIPO VEHÍCULO</span>
                        </td>
                        <td>
                            <i class="bi bi-person"></i> <strong
                                th:text="${detalle.cliente != null ? detalle.cliente.nombre : ''}">CLIENTE</strong><br>
                            <i class="bi bi-telephone"></i> <span
                                th:text="${detalle.cliente != null ? detalle.cliente.telefono : ''}">TELÉFONO</span><br>
                            <i class="bi bi-card-text"></i> <span
                                th:text="${detalle.cliente != null ? detalle.cliente.identificacion : ''}">IDENTIFICACIÓN</span>
                        </td>


                        <td>
                            <!-- Servicios -->
                            <div th:if="${#lists.size(detalle.listaDetalleVentasDTO) > 0}">
                                <strong><i class="bi bi-tools"></i> Servicios:</strong>
                                <div th:each="detalleVenta : ${detalle.listaDetalleVentasDTO}"
                                     th:if="${detalleVenta.tipoItemNombre == 'Servicio'}">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    <span th:text="${detalleVenta.nombreItem}"></span>
                                    - <strong th:text="'S/.' + ${detalleVenta.subtotal}"></strong>
                                    <br>
                                    <small>Atendido por: <span
                                            th:text="${detalleVenta.colaborador.nombre}"></span></small>
                                </div>
                            </div>
                            <hr style="margin: 10px 0;">

                            <!-- Productos -->
                            <div th:if="${#lists.size(detalle.listaDetalleVentasDTO) > 0}">
                                <strong><i class="bi bi-box"></i> Productos:</strong>
                                <div th:each="detalleVenta : ${detalle.listaDetalleVentasDTO}"
                                     th:if="${detalleVenta.tipoItemNombre == 'Producto'}">
                                    <i class="bi bi-cart-fill text-primary"></i>
                                    <span th:text="${detalleVenta.nombreItem}"></span>,
                                    x<span th:text="${detalleVenta.cantidad}"></span>
                                    <br>
                                    Subtotal: <strong th:text="'S/.' + ${detalleVenta.subtotal}"></strong>
                                </div>
                            </div>
                        </td>


                        <td>
                            <strong th:text="${detalle.formattedFecha != null ? detalle.formattedFecha : ''}">FECHA</strong><br>
                            <span th:text="${detalle.formattedHora != null ? detalle.formattedHora : ''}">HORA</span>
                        </td>


                        <td>
                            <button class="btn btn-success btn-sm add-service-btn" title="Añadir Servicio"
                                    data-bs-toggle="modal" data-bs-target="#addServicioModal"
                                    th:data-id="${detalle.id}">
                                <i class="bi bi-plus"></i>
                            </button>

                            <button class="btn btn-warning btn-sm" title="Pagar" data-bs-toggle="modal"
                                    data-bs-target="#pagarModal"
                                    th:data-id="${detalle.id}">
                                <i class="bi bi-currency-dollar"></i>
                            </button>


                            <button class="btn btn-primary btn-sm edit-btn" title="Editar"
                                    th:data-id="${detalle.id}"
                                    th:data-placa="${detalle.vehiculo != null ? detalle.vehiculo.placa : ''}"
                                    th:data-marca="${detalle.vehiculo != null ? detalle.vehiculo.marca : ''}"
                                    th:data-modelo="${detalle.vehiculo != null ? detalle.vehiculo.modelo : ''}"
                                    th:data-tipo-vehiculo="${detalle.vehiculo != null && detalle.vehiculo.tipo_vehiculo != null ? detalle.vehiculo.tipo_vehiculo.id : ''}"
                                    th:data-cliente="${detalle.cliente != null ? detalle.cliente.nombre : ''}"
                                    th:data-telefono="${detalle.cliente != null ? detalle.cliente.telefono : ''}"
                                    th:data-identificacion="${detalle.cliente != null ? detalle.cliente.identificacion : ''}"
                                    data-bs-toggle="modal" data-bs-target="#editIngresoModal">
                                <i class="bi bi-pencil"></i>
                            </button>


                            <button class="btn btn-danger btn-sm" title="Eliminar" th:data-id="${detalle.id}"
                                    onclick="eliminarDesdeBoton(this)">
                                <i class="bi bi-trash"></i>
                            </button>


                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>

        </div>

        <div class="modal fade" id="editIngresoModal" tabindex="-1" aria-labelledby="editIngresoModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editIngresoModalLabel">Editar Ingreso</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editIngresoForm">
                            <!-- Campo Placa -->
                            <div class="mb-3">
                                <label for="editPlaca" class="form-label">Placa</label>
                                <input type="text" id="editPlaca" class="form-control" required>
                            </div>

                            <!-- Sección Datos del Cliente -->
                            <h6>Datos del Cliente</h6>
                            <div class="mb-3">
                                <label for="editCliente" class="form-label">Nombre</label>
                                <input type="text" id="editCliente" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="editTelefono" class="form-label">Teléfono</label>
                                <input type="text" id="editTelefono" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="editIdentificacion" class="form-label">Identificación</label>
                                <input type="text" id="editIdentificacion" class="form-control" required>
                            </div>

                            <!-- Sección Datos del Vehículo -->
                            <h6>Datos del Vehículo</h6>
                            <div class="mb-3">
                                <label for="editMarca" class="form-label">Marca</label>
                                <input type="text" id="editMarca" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="editModelo" class="form-label">Modelo</label>
                                <input type="text" id="editModelo" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="editTipoVehiculo" class="form-label">Tipo de Vehículo</label>
                                <select class="form-select" id="editTipoVehiculo" required>
                                    <option value="" disabled>Seleccione el tipo de vehículo</option>
                                    <option th:each="tipoVehiculo : ${listaTipoVehiculo}"
                                            th:value="${tipoVehiculo.id}" th:text="${tipoVehiculo.nombre}">
                                    </option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" id="guardarEdicion">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            //llenar el modal con datos
            document.addEventListener("DOMContentLoaded", function () {
                const editButtons = document.querySelectorAll(".edit-btn");

                editButtons.forEach(button => {
                    button.addEventListener("click", function () {
                        // Asignar el ID al modal
                        const id = this.getAttribute("data-id");
                        const modal = document.getElementById("editIngresoModal");
                        modal.setAttribute("data-id", id);

                        // Llenar los campos del modal con los datos del botón
                        document.getElementById("editPlaca").value = this.getAttribute("data-placa");
                        document.getElementById("editCliente").value = this.getAttribute("data-cliente");
                        document.getElementById("editTelefono").value = this.getAttribute("data-telefono");
                        document.getElementById("editIdentificacion").value = this.getAttribute("data-identificacion");
                        document.getElementById("editMarca").value = this.getAttribute("data-marca");
                        document.getElementById("editModelo").value = this.getAttribute("data-modelo");
                        document.getElementById("editTipoVehiculo").value = this.getAttribute("data-tipo-vehiculo");
                    });
                });
            });


        </script>

        <script>
            //envio del boton editar:
            document.addEventListener("DOMContentLoaded", function () {
                // Referencia al botón Guardar del modal de edición
                const guardarBtn = document.getElementById("guardarEdicion");

                // Evento de click en el botón Guardar
                guardarBtn.addEventListener("click", async function () {
                    // Obtener los valores del formulario de edición
                    const id = document.getElementById("editIngresoModal").getAttribute("data-id");
                    const placa = document.getElementById("editPlaca").value.trim();
                    const nombre = document.getElementById("editCliente").value.trim() || "";
                    const telefono = document.getElementById("editTelefono").value.trim() || "";
                    const identificacion = document.getElementById("editIdentificacion").value.trim() || "";
                    const marca = document.getElementById("editMarca").value.trim() || "";
                    const modelo = document.getElementById("editModelo").value.trim() || "";
                    const idTipoVehiculo = document.getElementById("editTipoVehiculo").value || null;

                    // Validar que la placa esté presente
                    if (!placa) {
                        Swal.fire({
                            icon: 'error',
                            title: 'La placa es obligatoria.',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    try {
                        // Enviar los datos al backend mediante fetch
                        const response = await fetch(`/app/servicios/editar-detalle-servicio/${id}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: new URLSearchParams({
                                placa,
                                nombre,
                                telefono,
                                identificacion,
                                marca,
                                modelo,
                                idTipoVehiculo: idTipoVehiculo || ""
                            })
                        });

                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Detalle de servicio editado correctamente.',
                                confirmButtonText: 'Aceptar'
                            }).then(() => {
                                location.reload(); // Recargar la página
                            });
                        } else {
                            const errorText = await response.text();
                            Swal.fire({
                                icon: 'error',
                                title: 'Error al editar el detalle del servicio',
                                text: errorText,
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ocurrió un error',
                            text: error.message,
                            confirmButtonText: 'Aceptar'
                        });
                    }
                });
            });
        </script>

        <script>
            function eliminarDesdeBoton(boton) {
                const id = boton.getAttribute("data-id");
                eliminarIngreso(id);
            }

            function eliminarIngreso(id) {
                Swal.fire({
                    title: '¿Está seguro de que desea eliminar este ingreso?',
                    text: "Esta acción no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/app/servicios/eliminar-ingreso/${id}`, {
                            method: 'POST'
                        })
                            .then(response => {
                                if (response.ok) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Ingreso eliminado correctamente.',
                                        confirmButtonText: 'Aceptar'
                                    }).then(() => {
                                        location.reload(); // Recargar la página
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'No se pudo eliminar el ingreso.',
                                        confirmButtonText: 'Aceptar'
                                    });
                                }
                            })
                            .catch(error => {
                                console.error("Error:", error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Ocurrió un error',
                                    text: 'No se pudo eliminar el ingreso.',
                                    confirmButtonText: 'Aceptar'
                                });
                            });
                    }
                });
            }
        </script>


        <!-- Modal para Añadir Ingreso -->
        <div class="modal fade" id="addIngresoModal" tabindex="-1" aria-labelledby="addIngresoModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addIngresoModalLabel">Añadir Ingreso</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addIngresoForm">
                            <!-- Campo Placa -->
                            <div class="mb-3">
                                <small class="text-muted">Placa</small>
                                <div class="input-group">
                                    <input type="text" id="placa" class="form-control" placeholder="Ingrese la placa"
                                           required>
                                    <button class="btn btn-secondary" type="button"><i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Sección Datos del Cliente -->
                            <h6 class="mt-4">Datos del Cliente</h6>

                            <div class="mb-3">
                                <small class="text-muted">Nombre</small>
                                <div class="input-group">
                                    <input type="text" id="cliente" class="form-control" required readonly>
                                    <button type="button" class="btn btn-outline-secondary" id="editClienteBtn"
                                            disabled><i
                                            class="bi bi-pencil"></i></button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">Teléfono</small>
                                <div class="input-group">
                                    <input type="text" id="telefono" class="form-control" required readonly>
                                    <button type="button" class="btn btn-outline-secondary" id="editTelefonoBtn"
                                            disabled><i
                                            class="bi bi-pencil"></i></button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">Identificación</small>
                                <div class="input-group">
                                    <input type="text" id="identificacion" class="form-control" required readonly>
                                    <button type="button" class="btn btn-outline-secondary" id="editIdentificacionBtn"
                                            disabled><i class="bi bi-pencil"></i></button>
                                </div>
                            </div>

                            <!-- Sección Datos del Vehículo -->
                            <h6 class="mt-4">Datos del Vehículo</h6>

                            <div class="mb-3">
                                <small class="text-muted">Marca</small>
                                <div class="input-group">
                                    <input type="text" id="marca" class="form-control" required readonly>
                                    <button type="button" class="btn btn-outline-secondary" id="editMarcaBtn" disabled>
                                        <i
                                                class="bi bi-pencil"></i></button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">Modelo</small>
                                <div class="input-group">
                                    <input type="text" id="modelo" class="form-control" required readonly>
                                    <button type="button" class="btn btn-outline-secondary" id="editModeloBtn" disabled>
                                        <i
                                                class="bi bi-pencil"></i></button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">Tipo de Vehículo</small>
                                <div class="input-group">
                                    <select class="form-select" id="tipoVehiculo" name="tipoVehiculo" required>
                                        <option value="" selected disabled>Seleccione el tipo de vehículo</option>
                                        <option th:each="tipoVehiculo : ${listaTipoVehiculo}"
                                                th:value="${tipoVehiculo.id}"
                                                th:text="${tipoVehiculo.nombre}">
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" id="editTipoVehiculoBtn"
                                            disabled><i class="bi bi-pencil"></i></button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-warning" id="limpiarFormulario">Limpiar</button>
                        <button type="button" class="btn btn-primary" id="guardarIngreso" disabled>Guardar</button>
                    </div>
                </div>
            </div>
        </div>


        <!--Envio de datos al controlador-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Referencia al botón Guardar
                const guardarBtn = document.getElementById("guardarIngreso");

                // Evento de click en el botón Guardar
                guardarBtn.addEventListener("click", async function () {
                    // Obtener los valores de los campos (permitiendo valores vacíos)
                    const placa = document.getElementById("placa").value.trim();
                    const nombre = document.getElementById("cliente").value.trim() || "";
                    const telefono = document.getElementById("telefono").value.trim() || "";
                    const identificacion = document.getElementById("identificacion").value.trim() || "";
                    const marca = document.getElementById("marca").value.trim() || "";
                    const modelo = document.getElementById("modelo").value.trim() || "";
                    const idTipoVehiculo = document.getElementById("tipoVehiculo").value || null;

                    // Validar que la placa esté presente
                    if (!placa) {
                        Swal.fire({
                            icon: 'error',
                            title: 'La placa es obligatoria.',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    try {
                        // Enviar los datos al backend mediante fetch
                        const response = await fetch(`/app/servicios/agregar-ingreso/${placa}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: new URLSearchParams({
                                nombre,
                                telefono,
                                identificacion,
                                marca,
                                modelo,
                                idTipoVehiculo: idTipoVehiculo || ""
                            })
                        });

                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Ingreso agregado correctamente.',
                                confirmButtonText: 'Aceptar'
                            }).then(() => {
                                location.reload(); // Recargar la página
                            });
                        } else {
                            const errorText = await response.text();
                            Swal.fire({
                                icon: 'error',
                                title: 'Error al agregar el ingreso',
                                text: errorText,
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ocurrió un error',
                            text: error.message,
                            confirmButtonText: 'Aceptar'
                        });
                    }
                });
            });
        </script>

        <!--Logica para forzar busqueda de placa antes de agregar los demás campos-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const buscarBtn = document.querySelector("#placa + button");
                deshabilitarCamposInicialmente();

                buscarBtn.addEventListener("click", async function () {
                    const placaInput = document.getElementById("placa");
                    const placa = placaInput.value.trim();

                    if (!placa) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Por favor, ingrese una placa.',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    try {
                        const clienteResponse = await fetch(`/app/cliente/buscar-cliente-por-placa/${placa}`);
                        if (!clienteResponse.ok) throw new Error("Cliente no encontrado");

                        const cliente = await clienteResponse.json();
                        document.getElementById("cliente").value = cliente.nombre;
                        document.getElementById("telefono").value = cliente.telefono;
                        document.getElementById("identificacion").value = cliente.identificacion;

                        const vehiculoResponse = await fetch(`/app/cliente/buscar-vehiculo-por-placa/${placa}`);
                        if (!vehiculoResponse.ok) throw new Error("Vehículo no encontrado");

                        const vehiculo = await vehiculoResponse.json();
                        document.getElementById("marca").value = vehiculo.marca;
                        document.getElementById("modelo").value = vehiculo.modelo;
                        const tipoVehiculoId = vehiculo.tipoVehiculo.id;
                        const select = document.getElementById("tipoVehiculo");
                        for (let option of select.options) {
                            if (option.value == tipoVehiculoId) {
                                option.selected = true;
                                break;
                            }
                        }
                        deshabilitarCampos();
                        habilitarBotones();
                    } catch (error) {
                            Swal.fire({
                                icon: 'info',
                                title: 'Placa no encontrada.',
                                text: 'Puede ingresar nuevos datos.',
                                confirmButtonText: 'Aceptar'
                            });
                            habilitarCampos();
                        }
                });

                function deshabilitarCamposInicialmente() {
                    const campos = ["cliente", "telefono", "identificacion", "marca", "modelo", "tipoVehiculo"];
                    campos.forEach(campo => {
                        const input = document.getElementById(campo);
                        input.readOnly = true;
                        input.classList.add("disabled-input");
                    });
                    deshabilitarBotones();
                }

                function deshabilitarCampos() {
                    const campos = ["placa", "cliente", "telefono", "identificacion", "marca", "modelo", "tipoVehiculo"];
                    campos.forEach(campo => {
                        const input = document.getElementById(campo);
                        input.readOnly = true;
                        input.classList.add("disabled-input");
                    });
                }

                function habilitarCampos() {
                    const campos = ["placa", "cliente", "telefono", "identificacion", "marca", "modelo", "tipoVehiculo"];
                    campos.forEach(campo => {
                        const input = document.getElementById(campo);
                        input.readOnly = false;
                        input.classList.remove("disabled-input");
                    });
                    habilitarBotones();
                }

                function habilitarBotones() {
                    document.querySelector("#editClienteBtn").disabled = false;
                    document.querySelector("#editTelefonoBtn").disabled = false;
                    document.querySelector("#editIdentificacionBtn").disabled = false;
                    document.querySelector("#editMarcaBtn").disabled = false;
                    document.querySelector("#editModeloBtn").disabled = false;
                    document.querySelector("#editTipoVehiculoBtn").disabled = false;
                    document.querySelector("#limpiarFormulario").disabled = false;
                    document.querySelector("#guardarIngreso").disabled = false;
                }

                function deshabilitarBotones() {
                    document.querySelector("#editClienteBtn").disabled = true;
                    document.querySelector("#editTelefonoBtn").disabled = true;
                    document.querySelector("#editIdentificacionBtn").disabled = true;
                    document.querySelector("#editMarcaBtn").disabled = true;
                    document.querySelector("#editModeloBtn").disabled = true;
                    document.querySelector("#editTipoVehiculoBtn").disabled = true;
                    document.querySelector("#limpiarFormulario").disabled = true;
                    document.querySelector("#guardarIngreso").disabled = true;
                }
                document.querySelector("#editClienteBtn").addEventListener("click", function () { habilitarCampo("cliente"); });
                document.querySelector("#editTelefonoBtn").addEventListener("click", function () { habilitarCampo("telefono"); });
                document.querySelector("#editIdentificacionBtn").addEventListener("click", function () { habilitarCampo("identificacion"); });
                document.querySelector("#editMarcaBtn").addEventListener("click", function () { habilitarCampo("marca"); });
                document.querySelector("#editModeloBtn").addEventListener("click", function () { habilitarCampo("modelo"); });
                document.querySelector("#editTipoVehiculoBtn").addEventListener("click", function () { habilitarCampo("tipoVehiculo"); });

                document.querySelector("#limpiarFormulario").addEventListener("click", function () {
                    const campos = ["placa", "cliente", "telefono", "identificacion", "marca", "modelo", "tipoVehiculo"];
                    campos.forEach(campo => {
                        const input = document.getElementById(campo);
                        input.value = "";
                        input.readOnly = false;
                        input.classList.remove("disabled-input");
                    });
                    deshabilitarBotones();
                });

                function habilitarCampo(campo) {
                    const input = document.getElementById(campo);
                    input.readOnly = false;
                    input.classList.remove("disabled-input");
                }
            });
        </script>


        <!-- Modal para Añadir Servicio -->
        <div class="modal fade" id="addServicioModal" tabindex="-1" aria-labelledby="addServicioModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addServicioModalLabel">Añadir Servicio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addServicioForm" action="/app/servicios/agregar-detalle-venta" method="POST">
                            <!-- Tipo de Venta -->
                            <div class="mb-3">
                                <input type="hidden" name="idDetalle" id="detalleId">
                                <label for="tipoVenta" class="form-label">Tipo de Venta</label>
                                <select class="form-select" id="tipoVenta" name="tipoVenta" required>
                                    <option value="" selected disabled>Seleccione una opción</option>
                                    <option th:each="tipoItem : ${listaTipoItem}"
                                            th:value="${tipoItem.id}"
                                            th:text="${tipoItem.nombre}">
                                    </option>
                                </select>
                            </div>

                            <!-- Producto Container -->
                            <div id="productoContainer" class="mb-3 d-none">
                                <label for="producto" class="form-label">Producto</label>
                                <select class="form-select" id="producto" name="producto">
                                    <option value="" selected disabled>Seleccione una opción</option>
                                    <option th:each="producto : ${listaProductos}"
                                            th:value="${producto.id}"
                                            th:text="${producto.nombre}">
                                    </option>
                                </select>
                                <div class="mb-3" style="margin-top: 10px;">
                                    <label for="cantidad" class="form-label">Cantidad</label>
                                    <input type="number" name="cantidad" id="cantidad" class="form-control"
                                           placeholder="Ingresa la cantidad" value="1" min="1">
                                </div>
                            </div>


                            <!-- Servicio Container -->
                            <div id="servicioContainer" class="d-none">
                                <!-- Tipo de Servicio -->
                                <div class="mb-3">
                                    <label for="tipoServicio" class="form-label">Tipo de Servicio</label>
                                    <select class="form-select" id="tipoServicio" name="tipoServicio">
                                        <option selected disabled>Seleccione un tipo de servicio</option>
                                        <option value="Basico">Servicio Básico</option>
                                        <option value="Especial">Servicio Especial</option>
                                    </select>
                                </div>

                                <!-- Servicio Básico Container -->
                                <div id="servicioBasicoContainer" class="mb-3 d-none">
                                    <label for="servicioBasico" class="form-label">Servicio Básico</label>
                                    <select class="form-select" id="servicioBasico" name="servicioBasico">
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option th:each="servicioBasico : ${listaTipoServicioBasico}"
                                                th:value="${servicioBasico.id}"
                                                th:text="${servicioBasico.nombre}">
                                        </option>
                                    </select>
                                </div>

                                <!-- Servicio Especial Container -->
                                <div id="servicioEspecialContainer" class="mb-3 d-none">
                                    <label for="servicioEspecial" class="form-label">Servicio Especial</label>
                                    <select class="form-select" id="servicioEspecial" name="servicioEspecial">
                                        <option value="" selected disabled>Seleccione una opción</option>
                                        <option th:each="servicioEspecial : ${listaTipoServicioEspecial}"
                                                th:value="${servicioEspecial.id}"
                                                th:text="${servicioEspecial.nombre}">
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="precio" class="form-label">Precio</label>
                                <input class="form-control" type="number" name="precio" id="precio" min="0.01"
                                       step="0.01" placeholder="Precio por unidad" required>
                            </div>

                            <!-- Colaborador -->
                            <div class="mb-3">
                                <label for="collaboratorSelect" class="form-label">Colaborador</label>
                                <select class="form-select" id="collaboratorSelect" name="idColaborador" required>
                                    <option value="" selected disabled>Seleccione una opción</option>
                                    <th:block th:each="colaborador : ${listaColaboradores}">
                                        <option th:value="${colaborador.id}" th:text="${colaborador.nombre}"></option>
                                    </th:block>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary" form="addServicioForm">Guardar</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- JavaScript -->
        <script>
            //enviar el id del detalle servicio al modal:
                document.addEventListener('DOMContentLoaded', function () {
                    const addServiceButtons = document.querySelectorAll('.add-service-btn');
                    addServiceButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            const detalleId = this.getAttribute('data-id');
                            document.getElementById('detalleId').value = detalleId;
                        });
                    });
                });
            document.addEventListener('DOMContentLoaded', function () {
                // Cambios dinámicos en el tipo de venta
                const tipoVentaSelect = document.getElementById('tipoVenta');
                const productoContainer = document.getElementById('productoContainer');
                const servicioContainer = document.getElementById('servicioContainer');

                tipoVentaSelect.addEventListener('change', function () {
                    const tipo = tipoVentaSelect.value;
                    productoContainer.classList.toggle('d-none', tipo !== '2');
                    servicioContainer.classList.toggle('d-none', tipo !== '1');

                    // Si se muestra el contenedor de producto o servicio, selecciona el primer option
                    if (tipo === '2') { // Producto
                        document.getElementById('producto').selectedIndex = 0; // Selecciona el primer producto
                    }
                    if (tipo === '1') { // Servicio
                        document.getElementById('tipoServicio').selectedIndex = 0; // Selecciona el primer tipo de servicio
                        // Resetea los servicios básicos y especiales a su primer opción
                        document.getElementById('servicioBasico').selectedIndex = 0;
                        document.getElementById('servicioEspecial').selectedIndex = 0;
                    }
                });

                // Cambios dinámicos en el tipo de servicio
                const tipoServicioSelect = document.getElementById('tipoServicio');
                const servicioBasicoContainer = document.getElementById('servicioBasicoContainer');
                const servicioEspecialContainer = document.getElementById('servicioEspecialContainer');

                tipoServicioSelect.addEventListener('change', function () {
                    const tipoServicio = tipoServicioSelect.value;
                    servicioBasicoContainer.classList.toggle('d-none', tipoServicio !== 'Basico');
                    servicioEspecialContainer.classList.toggle('d-none', tipoServicio !== 'Especial');

                    // Resetea los servicios a su primer opción al mostrar un contenedor
                    if (tipoServicio === 'Basico') {
                        document.getElementById('servicioBasico').selectedIndex = 0;
                    }
                    if (tipoServicio === 'Especial') {
                        document.getElementById('servicioEspecial').selectedIndex = 0;
                    }
                });
            });
        </script>


        <!-- Modal para Pagar -->
        <div class="modal fade" id="pagarModal" tabindex="-1" aria-labelledby="pagarModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pagarModalLabel">Pagar</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>Producto/Servicio</th>
                                <th>Cantidad</th>
                                <th>Precio unitario</th>
                                <th>Subtotal</th>
                            </tr>
                            </thead>
                            <tbody id="detallePago">
                            <!-- Aquí se llenará dinámicamente con datos desde tu base de datos -->
                            </tbody>
                        </table>
                        <div class="mb-3">
                            <label for="total" class="form-label">Total:</label>
                            <input type="text" id="total" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="metodoPago" class="form-label">Método de Pago</label>
                            <select class="form-select" id="metodoPago" name="idMetodoPago" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <th:block th:each="metodopago : ${ListaMetodoPago}">
                                    <option th:value="${metodopago.id}" th:text="${metodopago.nombre}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-success" id="confirmarPago">Pagar</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const pagarModal = document.getElementById('pagarModal');
            pagarModal.addEventListener('show.bs.modal', async function (event) {
                const button = event.relatedTarget;  // Botón que abrió el modal
                const detalleId = button.getAttribute('data-id');  // ID del detalle ingreso

                try {
                    const response = await fetch(`/app/servicios/ingreso/${detalleId}`);
                    const servicios = await response.json();

                    const detallePago = document.getElementById('detallePago');
                    detallePago.innerHTML = '';  // Limpiar la tabla

                    let total = 0;
                    servicios.forEach(servicio => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-id', servicio.id);  // Agregar el atributo data-id aquí
                        row.innerHTML = `
                            <td>${servicio.nombreItem}</td>
                            <td>${servicio.cantidad}</td>
                            <td>${servicio.precio_unitario}</td>
                            <td>S/. ${servicio.subtotal}</td>
                        `;
                        detallePago.appendChild(row);
                        total += parseFloat(servicio.subtotal);  // Sumar el subtotal
                    });

                    document.getElementById('total').value = 'S/. ' + total.toFixed(2);
                } catch (error) {
                    console.error("Error al obtener los servicios:", error);
                }
            });

        </script>
        <script>
            document.getElementById('confirmarPago').addEventListener('click', async function () {
                // Obtener los datos del modal
                const total = document.getElementById('total').value.replace('S/. ', '').trim(); // Eliminar el prefijo de moneda
                const metodoPago = document.getElementById('metodoPago').value; // Obtener el método de pago
                const detallePagoRows = document.querySelectorAll('#detallePago tr'); // Filas de la tabla
                const detalleVentaIds = []; // Lista de IDs de detalle_venta

                // Extraer los IDs de detalle_venta (asumiendo que has agregado un atributo "data-id" en cada fila)
                detallePagoRows.forEach(row => {
                    const id = row.getAttribute('data-id'); // Asume que has agregado el atributo data-id en cada fila
                    if (id) {
                        detalleVentaIds.push(id);
                    }
                });

                // Validar datos requeridos
                if (!metodoPago || detalleVentaIds.length === 0) {
                    console.log('Método de pago seleccionado:', metodoPago);
                    console.log('Lista id detalle venta:', detalleVentaIds);
                    Swal.fire({
                        icon: 'error',
                        title: 'Debe seleccionar un método de pago y tener al menos un detalle para pagar.',
                        confirmButtonText: 'Aceptar'
                    });
                    return;
                }

                try {
                    // Crear un objeto JSON para enviar los datos
                    const data = {
                        total: total,
                        metodoPago: metodoPago,
                        detalleVentaIds: detalleVentaIds
                    };

                    // Verificar el contenido antes de enviarlo
                    console.log('Datos a enviar:', JSON.stringify(data));

                    // Realizar la solicitud POST con el objeto JSON
                    const response = await fetch('/app/servicios/venta', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json' // Establecemos el tipo de contenido a JSON
                        },
                        body: JSON.stringify(data) // Enviar el objeto JSON
                    });

                    if (response.ok) {
                        $('#pagarModal').modal('hide');
                        window.location.reload();
                    } else {
                        const error = await response.json();
                        console.error('Error al realizar el pago:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al realizar el pago',
                            text: error.message,
                            confirmButtonText: 'Aceptar'
                        });
                    }

                } catch (error) {
                    console.error('Error en la solicitud:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Ocurrió un error inesperado',
                        text: 'Inténtelo de nuevo más tarde.',
                        confirmButtonText: 'Aceptar'
                    });
                }

            });

        </script>

        <div class="tab-pane fade" id="realizados" role="tabpanel" aria-labelledby="realizados-tab" style="margin-bottom:100px;">
            <h4 class="text-center mb-4">Servicios y Productos Realizados</h4>
            <table id="realizadosTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                <tr>
                    <th>Nº</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Vehículo</th> <!-- Placa, marca y tipo de vehículo -->
                    <th>Cliente</th> <!-- Nombre, teléfono e identificación -->
                    <th>Servicios/Productos</th> <!-- Detalla servicios y productos realizados -->
                    <th>Total</th> <!-- Monto total de la venta -->
                    <th>Método de Pago</th> <!-- Efectivo, tarjeta, etc. -->
                </tr>
                </thead>
                <tbody>
                <th:block th:each="detalle, iterStat : ${listaIngresosRealizados}">
                    <tr>
                        <!-- Número -->
                        <td th:text="${iterStat.index + 1}">Nº</td>

                        <!-- Fecha y Hora -->
                        <td th:text="${detalle.formattedFecha != null ? detalle.formattedFecha : ''}">FECHA</td>
                        <td th:text="${detalle.formattedHora != null ? detalle.formattedHora : ''}">HORA</td>

                        <!-- Vehículo -->
                        <td>
                            <strong th:text="${detalle.vehiculo != null ? detalle.vehiculo.placa : ''}">PLACA</strong><br>
                            <span th:text="${detalle.vehiculo != null ? detalle.vehiculo.marca : ''}">MARCA</span><br>
                            <span th:text="${detalle.vehiculo != null && detalle.vehiculo.tipo_vehiculo != null ? detalle.vehiculo.tipo_vehiculo.nombre : ''}">TIPO</span>
                        </td>

                        <!-- Cliente -->
                        <td>
                            <i class="bi bi-person"></i> <strong th:text="${detalle.cliente != null ? detalle.cliente.nombre : ''}">CLIENTE</strong><br>
                            <i class="bi bi-telephone"></i> <span th:text="${detalle.cliente != null ? detalle.cliente.telefono : ''}">TELÉFONO</span><br>
                            <i class="bi bi-card-text"></i> <span th:text="${detalle.cliente != null ? detalle.cliente.identificacion : ''}">IDENTIFICACIÓN</span>
                        </td>

                        <!-- Servicios/Productos -->
                        <td>
                            <!-- Servicios -->
                            <div th:if="${#lists.size(detalle.listaDetalleVentasDTO) > 0}">
                                <strong><i class="bi bi-tools"></i> Servicios:</strong>
                                <ul style="list-style: none; padding-left: 1em;">
                                    <li th:each="detalleVenta : ${detalle.listaDetalleVentasDTO}" th:if="${detalleVenta.tipoItemNombre == 'Servicio'}">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <span th:text="${detalleVenta.nombreItem}"></span>
                                        - <strong th:text="'S/.' + ${detalleVenta.subtotal}"></strong><br>
                                        <small>Atendido por: <span th:text="${detalleVenta.colaborador.nombre}"></span></small>
                                    </li>
                                </ul>
                            </div>
                            <hr style="margin: 10px 0;">

                            <!-- Productos -->
                            <div th:if="${#lists.size(detalle.listaDetalleVentasDTO) > 0}">
                                <strong><i class="bi bi-box"></i> Productos:</strong>
                                <ul style="list-style: none; padding-left: 1em;">
                                    <li th:each="detalleVenta : ${detalle.listaDetalleVentasDTO}" th:if="${detalleVenta.tipoItemNombre == 'Producto'}">
                                        <i class="bi bi-cart-fill text-primary"></i>
                                        <span th:text="${detalleVenta.nombreItem}"></span>,
                                        x<span th:text="${detalleVenta.cantidad}"></span><br>
                                        Subtotal: <strong th:text="'S/.' + ${detalleVenta.subtotal}"></strong>
                                    </li>
                                </ul>
                            </div>
                        </td>

                        <!-- Total -->
                        <td th:text="'S/.' + ${detalle.venta.total}">TOTAL</td>

                        <!-- Método de Pago -->
                        <td th:text="${detalle.venta.metodoPago.nombre}">MÉTODO DE PAGO</td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>

    </div>
</div>


<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    $(document).ready(function () {
        var table = $('#example').DataTable({
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
        });
        var table = $('#realizadosTable').DataTable({
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
        });
    });


</script>

</body>

</html>